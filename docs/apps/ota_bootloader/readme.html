<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>OTA Boot Loader | Harmony 3 Wireles application examples for PIC32MZ W1 family</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="OTA Boot Loader" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 Wireless application examples for PIC32MZ W1 family" /> <meta property="og:description" content="Harmony 3 Wireless application examples for PIC32MZ W1 family" /> <link rel="canonical" href="../../apps/ota_bootloader/readme.html" /> <meta property="og:url" content="../../apps/ota_bootloader/readme.html" /> <meta property="og:site_name" content="Harmony 3 Wireles application examples for PIC32MZ W1 family" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="OTA Boot Loader" /> <script type="application/ld+json"> {"@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"../../assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"url":"../../apps/ota_bootloader/readme.html","headline":"OTA Boot Loader","description":"Harmony 3 Wireless application examples for PIC32MZ W1 family","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../" class="nav-list-link">Harmony 3 Wireless application examples for PIC32MZ W1 family</a><ul class="nav-list "><li class="nav-list-item active"><a href="../../apps/ota_bootloader/readme.html" class="nav-list-link active">OTA Boot Loader</a></li><li class="nav-list-item "><a href="../../apps/paho_mqtt_client/readme.html" class="nav-list-link">Paho MQTT Client</a></li><li class="nav-list-item "><a href="../../apps/paho_mqtt_tls_client/readme.html" class="nav-list-link">Paho MQTT TLS Client</a></li><li class="nav-list-item "><a href="../../apps/tcp_client/readme.html" class="nav-list-link">Secured TCP Client</a></li><li class="nav-list-item "><a href="../../apps/tcp_server/readme.html" class="nav-list-link">TCP Server</a></li><li class="nav-list-item "><a href="../../apps/udp_client/readme.html" class="nav-list-link">UDP Client</a></li><li class="nav-list-item "><a href="../../apps/udp_server/readme.html" class="nav-list-link">UDP Server</a></li><li class="nav-list-item "><a href="../../apps/weather_client/readme.html" class="nav-list-link">Weather Client</a></li><li class="nav-list-item "><a href="../../apps/wifi_easy_config/readme.html" class="nav-list-link">Wi-Fi Easy Configuration</a></li><li class="nav-list-item "><a href="../../apps/wifi_sta/config_driver_readme.html" class="nav-list-link">Wi-Fi STA (driver mode)</a></li><li class="nav-list-item "><a href="../../apps/wifi_sta/readme.html" class="nav-list-link">Wi-Fi STA (service mode)</a></li><li class="nav-list-item "><a href="../../apps/wifi_ap/readme.html" class="nav-list-link">Wi-Fi Soft AP (Service mode)</a></li><li class="nav-list-item "><a href="../../apps/wifi_ap/config_driver_readme.html" class="nav-list-link">Wi-Fi Soft AP (driver mode)</a></li><li class="nav-list-item "><a href="../../apps/wifi_eth_dual_interface/readme.html" class="nav-list-link">Wi-Fi ethernet dual interface</a></li><li class="nav-list-item "><a href="../../apps/wifi_touch_demo/readme.html" class="nav-list-link">WiFi Touch Demo</a></li></ul></li><li class="nav-list-item"><a href="../../release_notes.html" class="nav-list-link">Release notes</a></li><li class="nav-list-item"><a href="../../mplab_harmony_license.html" class="nav-list-link">License</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Harmony 3 Wireles application examples for PIC32MZ W1 family" aria-label="Search Harmony 3 Wireles application examples for PIC32MZ W1 family" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../">Harmony 3 Wireless application examples for PIC32MZ W1 family</a></li> <li class="breadcrumb-nav-list-item"><span>OTA Boot Loader</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><a href="https://www.microchip.com"><img src="https://www.microchip.com/ResourcePackages/Microchip/assets/dist/images/logo.png" alt="MCHP" /></a></p> <h1 id="ota-boot-loader"> <a href="#ota-boot-loader" aria-labelledby="ota-boot-loader" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OTA Boot Loader </h1> <p>This example acts as loader of OTA image (downloaded using OTA process) to load it to device memory .</p> <h2 id="description"> <a href="#description" aria-labelledby="description" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Description </h2> <p>This bootloader project can be used by user to program an image , which is downloaded through OTA process. It is required to build this project first using its IDE (MPLABX) before building OTA application, as the image of the bootloader will be integrated with the “wifi_ota_app_upgrade” application image.</p> <p>During boot-up, bootloader will check if any new valid image available in the external flash. If available, it chooses the newly (latest downloaded) available image in the External flash (sst26vf) and program it to Program-Flash area of the device. Bootloader uses SPI protocol to program the image from the external flash.</p> <p>If there is no new downloaded image present in the external flash, bootloader will handover the control to current application present in the program-flash area and application will start executing.</p> <p>The External flash will be configured for 3 slots for storing upto 3 OTA images. Each slot is of size 832KB. Each OTA image will also include header to maintain the image status and SHA-256 Digest signature. Bootloader is having the logic to choose the best suitable valid image, based on the header status of the images and program it to the device.</p> <h2 id="ota-bootloader-framework-architecture"> <a href="#ota-bootloader-framework-architecture" aria-labelledby="ota-bootloader-framework-architecture" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OTA Bootloader framework Architecture </h2> <ol> <li> <p>Abstraction Model:</p> <p><img src="images/abstraction_model.PNG" alt="" /></p> <ul> <li>OTA application is responsible to start the OTA process and download new image to Image Store in the external flash (sst26vf).</li> <li>Image downloading is done through HTTP protocol.</li> <li>Bootloader is responsible for the programming process, which loads and copies the best image from Image Store to Program area and jumps to the Application. The bootloader also supports ‘Fail-Safe’ boot scheme which the firmware automatically rolls back if the image has not been run correctly at the previous boot.</li> <li>Image-Store can have multiple images, including the default image for factory reset.</li> </ul> </li> <li> <p>During each system boot-up, bootloader checks if it needs to program any image from the external flash. Bootloader goes to program mode, if-</p> <p>a) any newly downloaded image present in the external flash,</p> <p>b) if the already present image in the program flash is identified as “not safe” during previous boot.</p> <p>There are two conditions :</p> <ul> <li>whether the Application Image in Program-Flash area is valid (indicated by the STATUS field, value of 0xF8 in image Header), and</li> <li>whether it has been confirmed that no errors were present during the previous boot (indicated by the STATUS field (of image Header) value of 0xF8 in the original image located in the external flash).</li> </ul> <p>According to bootloader logic if these two conditions are satisfied it will not go to “Program Mode” and the bootloader immediately jumps to the application image present in the program-flash area of the device.</p> </li> <li> <p>If two conditions mentioned in the step 2 are not satisfied, the Bootloader switches to Image Program Mode. In Image Program Mode bootloader follows Image Programming sequence, which finds the highest ranked image in Image-Store(external flash), erases the Program-Flash area and copies the selected image to the Program-Flash area if the image is successfully verified. As the newly downloaded image is set as the highest rank, during the first boot time after the Image-downloading, the Bootloader attempts to load the newly downloaded image at the first try.</p> <p>Bootloader choses the highest ranked image to boot. The images are ranked in following order:</p> <ol> <li> <p>The latest downloaded Image</p> </li> <li> <p>The next booted image</p> </li> <li> <p>The next known booted image</p> </li> <li> <p>Default (Golden) image</p> </li> </ol> </li> <li> <p>If the image is not valid, the bootloader invalidates the image by setting “Invalidate” 0xF0 in STATUS field of header present in the external flash and restarts the Image-Programming sequence.</p> </li> <li> <p>If image is verfied successfully, Bootloader updates STATUS field of the image header in external flash-</p> <p>a) checks the header-status field, if it is “Downloaded” (0xFE) updates it as “Unbooted”(0xFC) and jumps to application image.</p> <p>b) if already a validated image (header-status value is “0xF8”), it starts running application image ignoring above mentioned step a).</p> </li> <li> <p>Header structure :</p> <p><img src="../../apps/ota_bootloader/images/ota_header.PNG" alt="ota_header" /></p> </li> <li> <p>Flow chart :</p> <p><img src="../../apps/ota_bootloader/images/bootloader_chart.PNG" alt="flowchart" /></p> </li> </ol> <h2 id="downloading-and-generating-bootloader-code"> <a href="#downloading-and-generating-bootloader-code" aria-labelledby="downloading-and-generating-bootloader-code" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Downloading and Generating Bootloader Code </h2> <p>To download or clone this application from Github, go to the <a href="https://github.com/Microchip-MPLAB-Harmony/wireless_apps_pic32mzw1_wfi32e01">top level of the repository</a></p> <p>Path of the project within the repository is <strong>apps/ota_bootloader/firmware</strong>.</p> <p>To genearte code, refer to the following table and open the project using its IDE.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Project Name</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>ota_bootloader.X</td> <td>MPLABX project for PIC32MZ W1 Curiosity Board</td> </tr> <tr> <td> </td> <td> </td> </tr> </tbody> </table></div> <h2 id="setting-up-pic32mz-w1-curiosity-board"> <a href="#setting-up-pic32mz-w1-curiosity-board" aria-labelledby="setting-up-pic32mz-w1-curiosity-board" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up PIC32MZ W1 Curiosity Board </h2> <ul> <li>Connect the Debug USB port on the board to the computer using a micro USB cable</li> </ul> <h2 id="generating-bootloader-code"> <a href="#generating-bootloader-code" aria-labelledby="generating-bootloader-code" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generating BootLoader Code </h2> <ol> <li>Open “ota_bootloader” project and launch Harmony3 configurator. Path of the application within the repository is <strong>apps/ota_bootloader/firmware</strong>.</li> <li>Generate code via MHC.</li> </ol> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='../../assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2021 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
