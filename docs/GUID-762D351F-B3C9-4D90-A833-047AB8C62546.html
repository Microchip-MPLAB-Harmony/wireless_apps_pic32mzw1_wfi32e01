<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="topic" />
<meta name="DC.title" content="Over The Air (OTA) Programming Using Wi-Fi" />
<meta name="DC.relation" scheme="URI" content="GUID-60AE2339-6045-4BAA-AEBC-AAEE24D8C566.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="over-the-air-ota-programming-using-wi-fi" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>Over The Air (OTA) Programming Using Wi-Fi</title>
<meta name="Microsoft.Help.Id" content="GUID-6863E711-3A96-49BC-B369-8645955ECCD6-over-the-air-ota-programming-using-wi-fi" />
<meta name="Microsoft.Help.TocParent" content="GUID-6863E711-3A96-49BC-B369-8645955ECCD6" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB Harmony Wireless application examples for PIC32MZ W1 family Reference A 10/2023" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-762D351F-B3C9-4D90-A833-047AB8C62546"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="over-the-air-ota-programming-using-wi-fi">
<h1 class="title topictitle1" id="ariaid-title1" style="">Over The Air (OTA) Programming Using Wi-Fi</h1><div class="body"><p class="p">This example application acts as a Wi-Fi Station(STA) to connect to Access point(AP) and perform OTA application update process to download an image present in the user defined OTA-HTTP server.</p>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-60AE2339-6045-4BAA-AEBC-AAEE24D8C566.html">Harmony 3 Wireless application examples for PIC32MZ W1 family</a></div>
</div>
</div><div class="topic nested1" aria-labelledby="ariaid-title2" id="description"><h2 class="title topictitle2" id="ariaid-title2" style="">Description</h2><div class="body"><p class="p">This application demonstrates how a user can perform OTA application upgrade using Wi-Fi. The user would need to configure the Home AP credentials (like SSID and security items). The Wi-Fi service will use the credentials to connect to the Home AP and acquire an IP address. Once the IP address is obtained application will perform OTA update process.</p>
<br /><img class="image" src="GUID-14DE7F63-D45F-4C34-81F7-8D15A8FBAA8A-low.png" alt="resized_wifi_sta_http_server_1" /><br /><p class="p">Application will try to connect with the defined server address and download the new image. The downloaded image will be stored in the external flash (sst26vf) initially. Application will reset the device to run new image once image is successfully downloaded from server. When device is reset ,bootloader will try to program the image from the external flash and if programming is successful ,downloaded image from the server will be executed .</p>
<p class="p">It is required to build "ota_bootloader" project located in the apps folder of <code class="ph codeph">wireless_apps_pic32mzw1_wfi32e01</code> repo first before building this application as the image of the bootloader application will be used to integrate with the "wifi_ota_app_upgrade" application image. A unified hex file will be built using Hexmate tool and the unified HEX image will be loaded to the device. More details about this can be found in "Running Application" section below.</p>
<p class="p">This application uses File System, a harmony component which internally use SPI protocol to place the newly downloaded image to the external flash.</p>
<br /><img class="image" src="GUID-F6229610-6517-403F-B091-530CBC5DDBC9-low.png" alt="spi_com" /><br /></div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title3" id="ota-application-framework-architecture"><h2 class="title topictitle2" id="ariaid-title3" style="">OTA Application framework Architecture</h2><div class="body"><p class="p">Over the Air (OTA) firmware upgrade feature is designed with a two step process, Image Downloading and Image Programming process. Image Downloading process is done by <code class="ph codeph">OTA SERVICE</code>, harmony componet and <code class="ph codeph">ota_bootloader</code> will take care of programming process.</p>
<p class="p">Abstraction model:</p>
<br /><img class="image" src="GUID-562A7C18-F3CA-4203-8DDB-E9ABECFECB5D-low.png" alt="abstraction_model" /><br /><p class="p"><strong class="ph b">User Application:</strong> This is where the customer application logic is built.</p>
<p class="p"><strong class="ph b">OTA Service:</strong> This layer includes the service level logic implementation. This is a Harmony component which provides certain user configurable parameters(ex- Version, Periodic update check etc.) . Based on user configuration, generated code will be activated with required functionalities.</p>
<br /><img class="image" src="GUID-86595BF4-AF05-4154-8DC1-DBACC49E6076-low.png" alt="ota_service_component" /><br /><br /><img class="image" src="GUID-DDF7B039-BA19-4A78-99C2-B04A476E97D7-low.png" alt="ota_service_conf" /><br /><p class="p"><strong class="ph b">OTA software platform / OTA Core :</strong> This is the platform layer that consist of the main OTA logic implementation. When OTA process is triggered , this layer will communicate with the transport layer to connect to OTA server. If new image is available , it will initiate download using transport layer. If successfully downloaded, it will store the new image into the File System .</p>
<p class="p"><strong class="ph b">File System :</strong>  The architecture is designed to provide flexibility for the customer to choose the storage medium (ex- SST26 SPI flash, SD card, USB MSD in host mode etc.). Any medium supported by the Harmony3 file system can be used with the OTA service.</p>
<p class="p"><strong class="ph b">Bootloader :</strong> This layer consists of the logic to safely program images from the file system (external) into program the program memory (NVM) of the device. At device boot, the bootloader will check if a new image is available in the external image store and transfer it to the NVM.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title4" id="securing-ota-by-verifying-images-in-bootloader"><h2 class="title topictitle2" id="ariaid-title4" style="">Securing OTA by verifying Images in Bootloader</h2><div class="body"><p class="p">We have implemented 2 configurations of OTA Bootloader to perform signature verification of images:</p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">In software using Wolfcrypt (ota_booloader_wolfcrypt.x).</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">In Hardware using Trust Flex device (ota_booloader_trustflex.x).</p>
</li>
</ol>
<p class="p">By default, application is configured for <code class="ph codeph">ota_booloader_wolfcrypt.x</code>, in which signature verification will be done using <code class="ph codeph">wolfcrypt</code> library.</p>
<p class="p">User need to load the corresponding bootloader configuration as <code class="ph codeph">loadable</code> component as per application requirement.Loading bootloader into application is required , only for generating <code class="ph codeph">factory</code> image. For more information on configuring <code class="ph codeph">loadable project</code> , please refer <code class="ph codeph">OTA System Service Configuration</code> section of <code class="ph codeph">configuration.md</code>.</p>
<p class="p">For more details , Please follow documentation provided for <strong class="ph b">Over The Air (OTA) firmware update System Service</strong>.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title5" id="ota-server-json-manifest"><h2 class="title topictitle2" id="ariaid-title5" style="">OTA server JSON manifest</h2><div class="body"><p class="p">The Application expects the HTTP based OTA server to provide metadata of images available in the server in <code class="ph codeph">json</code> format. During update checks, the OTA service will download and parse this manifest file. Each entry in the manifest file should include the following fields :</p>
<ul class="ul"><li class="li"><p class="p"><strong class="ph b"><code class="ph codeph">Version</code></strong> indicates the application version number. It is a integer value.</p>
</li>
<li class="li"><p class="p"><strong class="ph b"><code class="ph codeph">URL</code></strong> contains the image path from which the application image can be downloaded. It is a string variable.</p>
</li>
<li class="li"><p class="p"><strong class="ph b"><code class="ph codeph">Digest</code></strong>  contain the <code class="ph codeph">SHA256</code> digest of image to be downloaded. It is a 64 byte string variable an should not include whitespaces</p>
</li>
<li class="li"><p class="p"><strong class="ph b"><code class="ph codeph">Signature</code></strong> This <em class="ph i"><strong class="ph b">optional</strong></em> field provides a capability to verify image. Signature of image will be provided by user, which will be used by bootloader to perform signature verification of image.</p>
<p class="p">If this field is missing from Manifest file, application will not store any <code class="ph codeph">Signature</code> in OTA database. But it is user responsibilty to undefine macro <code class="ph codeph">SYS_OTA_SECURE_BOOT_ENABLED</code> in <code class="ph codeph">bootloader</code> project to disable <code class="ph codeph">Signature</code> verfication of images. In this case, only <code class="ph codeph">Digest</code> verification will be done by bootloader.</p>
<p class="p">Please follow <code class="ph codeph">Using bootloader for Non-secure OTA</code> section of <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_apps_pic32mzw1_wfi32e01/blob/master/apps/ota_bootloader/readme.md" target="_blank">boolader</a> manual.</p>
</li>
<li class="li"><p class="p"><strong class="ph b"><code class="ph codeph">EraseVer</code></strong> This <em class="ph i"><strong class="ph b">optional</strong></em> field provides a capability to trigger an erase of an version which was downloaded earlier. Customer may want to remove an image from the image store due to various reason, application with bug, may be one of them. It is a bool variable.</p>
<ul class="ul"><li class="li"><p class="p">If user configures this field as "true", OTA serice will delete image version mentioned in "Version" field.</p>
</li>
<li class="li"><p class="p">If user configures this field as "false", OTA service will follow image downwload logic.
<strong class="ph b">Sample JSON</strong></p>
</li>
</ul>
</li>
</ul>
<pre class="pre codeblock json">    {
    
    <span class="hl-json_key">"ota"</span>: [
            {
                <span class="hl-json_key">"Version"</span>: <span class="hl-number">3</span>,
                <span class="hl-json_key">"URL"</span>: <span class="hl-string">"http://192.168.43.173:8000/wifi_ota103.bin"</span>,
                <span class="hl-json_key">"Digest"</span>: <span class="hl-string">"745189cbb24b752a0175de1f9d5d61433ba47d89aff5b5a3686f54ca2d5dfb22"</span>,
                <span class="hl-json_key">"Signature"</span>: <span class="hl-string">"pra2wlOiZO/zjzqaP9DZGe9dmm0aC4gx4r0yoyI7DU3sVpkdJ034v5XoiN5jdpeuLRge4RjsB/KSrVho8pwC2w=="</span>,
                <span class="hl-json_key">"EraseVer"</span>: false
            },
            {
                <span class="hl-json_key">"Version"</span>: <span class="hl-number">6</span>,
                <span class="hl-json_key">"URL"</span>: <span class="hl-string">"http://192.168.43.173:8000/wifi_ota100.bin"</span>,
                <span class="hl-json_key">"Digest"</span>: <span class="hl-string">"885189cbb24b7b1a0175deef9d5d61f53c247d89a095b5a3686f54ca2d5dfbaa"</span>,
                <span class="hl-json_key">"Signature"</span>: <span class="hl-string">"pra2wlOiZO/zjzqaP9DZGe9dmm0aC4gx4r0yoyI7DU3sVpkdJ034v5XoiN5jdpeuLRge4RjsB/KSrVho8pwC2w=="</span>,
                <span class="hl-json_key">"EraseVer"</span>: false
            }
           ]
    }</pre><p class="p">OTA service will download json file from server first when update check process is triggered by application, try to fetch information and proceed further .</p>
<p class="p"><strong class="ph b">For more details , Please follow documentation provided for Over The Air (OTA) firmware update System Service</strong>.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title6" id="ota-image-generation"><h2 class="title topictitle2" id="ariaid-title6" style="">OTA image generation</h2><div class="body"><p class="p">Please refer <code class="ph codeph">Generating OTA image section</code> in <code class="ph codeph">usage</code> manual present in the documentation of <strong class="ph b">Over The Air (OTA) firmware update System Service</strong>.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title7" id="downloading-and-building-the-application"><h2 class="title topictitle2" id="ariaid-title7" style="">Downloading and building the application</h2><div class="body"><p class="p">To download or clone this application from Github, go to the <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_apps_pic32mzw1_wfi32e01" target="_blank">top level of the repository</a></p>
<p class="p">Path of the application within the repository is <strong class="ph b">apps/wifi_ota_app_upgrade/firmware</strong> .</p>
<p class="p">To build the application, refer to the following table and open the project using its IDE.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d10943e257"><span>Project Name</span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d10943e259"><span>Description</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d10943e257 "><span>pic32mz_w1_curiosity_freertos.X</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d10943e259 "><span>MPLABX project for PIC32MZ W1 Curiosity Board</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" colspan="2" style="vertical-align:middle;" headers="d10943e257 d10943e259 "><span> </span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title8" id="setting-up-pic32mz-w1-curiosity-board"><h2 class="title topictitle2" id="ariaid-title8" style="">Setting up PIC32MZ W1 Curiosity Board</h2><div class="body"><ul class="ul"><li class="li"><p class="p">Connect the Debug USB port on the board to the computer using a micro USB cable</p>
</li>
<li class="li"><p class="p">On the GPIO Header (J207), connect U1RX (PIN 13) and U1TX (PIN 23) to TX and RX pin of any USB to UART converter</p>
</li>
<li class="li"><p class="p">Home AP (Wi-Fi Access Point with internet connection)</p>
</li>
<li class="li"><p class="p">HTTP server.</p>
</li>
<li class="li"><p class="p">python 3.9.0 .</p>
</li>
</ul>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title9" id="running-the-application"><h2 class="title topictitle2" id="ariaid-title9" style="">Running the Application</h2><div class="body"><ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Open the project "wifi_ota_app_upgrade".</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">Demo is configured with the default wifi credentials shown in the image below. To change the configurations launch the Harmony 3 configurator and update the home AP credentials for STA Mode and generate code.</p>
<br /><img class="image" src="GUID-4120AA9A-9A2D-439B-A8EB-AB6187572D56-low.png" alt="resized_wifi_sta_MHC1" /><br /></li>
<li class="li"><span class="indent-level-default">3.</span><p class="p">Configuring server url :</p>
<br /><img class="image" src="GUID-B43AAA40-5D61-4700-8B24-7DDAD7F6522F-low.png" alt="resized_srvr_confg_in_mhc" /><br /><p class="p">For more details on manifest file, please follow <code class="ph codeph">OTA server JSON manifest</code> section of <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_system_pic32mzw1_wfi32e01/blob/master/system/ota/docs/usage.md" target="_blank">usage</a> manual, which is part of <code class="ph codeph">ota</code> system component.</p>
</li>
<li class="li"><span class="indent-level-default">4.</span><p class="p">As a part of OTA process device will try to connect to user defined HTTP server. If device is able to connect to server without any error, it will try to fetch json manifest information .</p>
<ul class="ul"><li class="li"><p class="p">User can use any HTTP server.</p>
</li>
<li class="li"><p class="p">User may also use python command to create a local http server using below steps:</p>
<ul class="ul"><li class="li with-image"><p class="p">Open command prompt and change driectory to the folder where ota image is present.</p>
<br /><img class="image" src="GUID-19779A7F-ED44-42C0-A43A-4A4CAE913F8E-low.png" alt="resized_Change_dir" /><br /></li>
</ul>
</li>
<li class="li with-image"><p class="p">Use below python command in command prompt:<code class="ph codeph">python -m http.server 8000</code></p>
<br /><img class="image" src="GUID-91CEC460-BF61-4E72-AB71-68B6BA66652D-low.png" alt="resized_http_server" /><br /></li>
</ul>
</li>
<li class="li"><span class="indent-level-default">5.</span><p class="p">Default Application supports Non-secure OTA. To enable Secure-OTA , please follow details provided in <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_apps_pic32mzw1_wfi32e01/blob/master/apps/ota_bootloader/readme.md" target="_blank">Bootloader document.</a></p>
</li>
<li class="li"><span class="indent-level-default">6.</span><p class="p">Generate the code using MHC.</p>
</li>
<li class="li"><span class="indent-level-default">7.</span><p class="p">To create factory reset image , It is required to integrate the bootloader and ota application image and create a single unified HEX file. To integrate 2 images we can use hexmate tool, which is readily available with MPLABX package as part of the standard installation.To combine the hex files -</p>
<ul class="ul"><li class="li with-image"><p class="p">User should load the "ota_bootloader" project located in the  apps folder of "wireless_apps_pic32mzw1_wfi32e01" repo and include it into "wifi_ota_app_upgrade" project as a "Loadable" component. For this, right click on the "wifi_ota_app_upgrade" project, click on "properties" and  select "ota_bootloader" project. User need to make sure that the steps mentioned in "ota_bootloader" reference document is followed, before this step.</p>
<br /><img class="image" src="GUID-C05EBC59-6162-4BBA-8FB4-AE14F32BCDB0-low.png" alt="project_loading" /><br /><br /><img class="image" src="GUID-5E9C8475-FFAE-444B-8C7F-289AFC26D9EB-low.png" alt="project_loading_1" /><br /></li>
<li class="li with-image"><p class="p">Click on "Apply" button to make the applied changes effective:</p>
<br /><img class="image" src="GUID-2EDC5A2F-22B9-4A1A-A79B-DC256359A681-low.png" alt="project_loading_2" /><br /></li>
</ul>
</li>
<li class="li"><span class="indent-level-default">8.</span><p class="p">Build and program the application.</p>
</li>
<li class="li"><span class="indent-level-default">9.</span><p class="p">Connect to a USB to UART converter to UART1 and Open a Terminal application (Ex.:Tera term) on the computer. Configure the serial settings as follows:</p>
<ul class="ul"><li class="li"><p class="p">Baud : 115200</p>
</li>
<li class="li"><p class="p">Data : 8 Bits</p>
</li>
<li class="li"><p class="p">Parity : None</p>
</li>
<li class="li"><p class="p">Stop : 1 Bit</p>
</li>
<li class="li"><p class="p">Flow Control : None</p>
</li>
</ul>
</li>
<li class="li"><span class="indent-level-default">10.</span><p class="p">The device will connect to the Home AP and print the IP address obtained.</p>
<br /><img class="image" src="GUID-403B0296-E89A-47DF-9B64-4130020C697E-low.png" alt="wifi_sta_log1" /><br /></li>
<li class="li"><span class="indent-level-default">11.</span><p class="p">Once IP address is obtained the device will initiate OTA process and try to fetch json manifest content, periodically for every 60 sec .</p>
</li>
<li class="li"><span class="indent-level-default">12.</span><p class="p">User should make sure that both HTTP server and the PIC32MZW1 device are part of same wifi network (or connected to same Home AP).</p>
</li>
<li class="li"><span class="indent-level-default">13.</span><p class="p">User can see periodical messages as shown in belo screen shot :</p>
<br /><img class="image" src="GUID-13EA1555-6FD0-4EC3-B434-DE51E642E0B6-low.png" alt="ota_peridocal_msg" /><br /></li>
<li class="li"><span class="indent-level-default">14.</span><p class="p">In case , secure-ota is enabled please store <code class="ph codeph">Factory image</code> signature into system (External flash). Please follow steps provided in <code class="ph codeph">Verification of factory image</code> section of <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_system_pic32mzw1_wfi32e01/blob/master/system/ota/docs/usage.md" target="_blank">usage</a> manual, which is part of <code class="ph codeph">ota</code> system component.</p>
</li>
<li class="li"><span class="indent-level-default">15.</span><p class="p">It is required to perform a "post-build" step to create ota image with file extension ".bin" (which can be placed in the server and downloaded during OTA process).</p>
<ul class="ul"><li class="li with-image"><p class="p">All required files for post-build process will be generated (during <code class="ph codeph">step 5)</code>, mentioned above) automatically in "tools" folder, created inside project folder.</p>
<br /><img class="image" src="GUID-5C421474-4155-42A0-BFF7-EA484BC4F8E4-low.png" alt="tools_folder" /><br /></li>
<li class="li with-image"><p class="p">Right click on the "wifi_ota_app_upgrade" project and click on properties.</p>
<br /><img class="image" src="GUID-C05EBC59-6162-4BBA-8FB4-AE14F32BCDB0-low.png" alt="project_loading" /><br /></li>
<li class="li with-image"><p class="p">Select "building", insert below command and click "OK":</p>
<p class="p"><code class="ph codeph">../../tools/hex2bin/hex2bin.exe</code></p>
<p class="p"><strong class="ph b">Note</strong>: python should be present in the system variable path.</p>
<br /><img class="image" src="GUID-B1CAAA53-3A1A-4C1C-8507-145C155A111B-low.png" alt="post_build" /><br /><p class="p"><strong class="ph b">For more details , Please follow documentation provided in <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_system_pic32mzw1_wfi32e01/tree/master/system/ota/docs" target="_blank">link</a></strong></p>
</li>
</ul>
</li>
<li class="li"><span class="indent-level-default">16.</span><p class="p">For the <code class="ph codeph">.bin</code> OTA image to be downloded, user can use the same project "wifi_ota_app_upgrade":</p>
<ul class="ul"><li class="li"><p class="p">User should change the "version number" in the OTA component in the MHC higher than currently running image. Ensure the same version number is there in the json file also.</p>
</li>
<li class="li"><p class="p">Compile the project.</p>
</li>
<li class="li"><p class="p">Update the "Digest" and other relevant fields in the json file corresponding to the ota image to be downloaded. The "Digest" is printed in the compilation logs.</p>
</li>
<li class="li"><p class="p">Place the <code class="ph codeph">.bin</code> image to be downloded, into the HTTP server. The <code class="ph codeph">.bin</code> image can be found in below path which is generated during "wifi_ota_app_upgrade" project build :
<code class="ph codeph">..\firmware\wifi_ota_app_upgrade.X\dist\pic32mz_w1_curiosity_freertos\production</code></p>
<p class="p">Please follow <code class="ph codeph">OTA server JSON manifest</code> section of <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_system_pic32mzw1_wfi32e01/blob/master/system/ota/docs/usage.md" target="_blank">usage</a> manual, which is part of <code class="ph codeph">ota</code> system component.</p>
</li>
</ul>
</li>
<li class="li"><span class="indent-level-default">17.</span><p class="p">In case the user wants to download any other '.bin' image, they need to ensure that the digest corresponding to the image is calculated and updated in the json file.</p>
</li>
<li class="li"><span class="indent-level-default">18.</span><p class="p">Once image is downloaded successfully, the application will print a message in the console. User need to reset the device to load the new image.</p>
<br /><img class="image" src="GUID-8EBE2506-8AAC-45A2-B70D-E60960DD196A-low.png" alt="ota_process_pass" /><br /></li>
<li class="li"><span class="indent-level-default">19.</span><p class="p">If OTA upgrade fails, user need to reset the device to initiate OTA process again.</p>
</li>
<li class="li"><span class="indent-level-default">20.</span><p class="p">During reset, device will check if any newly downloaded image is available in the external flash(sst26vf):</p>
<ul class="ul"><li class="li"><p class="p">if yes, bootloader will program new image to program-flash area of the device from external flash.</p>
<ul class="ul"><li class="li"><p class="p">if programming is successful, bootloader will perform signature verification (if secure-ota is enabled sinature verification will be performed ,otherwise signature verification will not be performed), digest verification of image and if verification is succssful, bootloader will hand over control and application will start executing if.</p>
</li>
<li class="li"><p class="p">if verifiction is failed , bootloader will try to load previous successful image</p>
</li>
</ul>
<p class="p">For more details please follow <code class="ph codeph">Flow chart</code> provided in <a class="xref" href="https://github.com/Microchip-MPLAB-Harmony/wireless_system_pic32mzw1_wfi32e01/blob/master/system/ota/docs/usage.md" target="_blank">usage</a> manual, which is part of <code class="ph codeph">ota</code> system component.</p>
</li>
<li class="li"><p class="p">if no new image is available then bootloader will hand over control without programming any image and application image already present in the program-flash area will start executing</p>
</li>
</ul>
</li>
<li class="li"><span class="indent-level-default">21.</span><p class="p">User will come to know if new image is running by checking the version number in console print.</p>
</li>
</ol>
</div>
</div>
</body>
</html>